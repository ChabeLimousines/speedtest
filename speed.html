<html>
<head>
<script type="application/javascript" src="./jquery.js" ></script>
<script type="application/javascript" src="./jquery.ajax-progress.js" ></script>
<script type="application/javascript">

//var target_size = 1;
var lock = false;
var test_start = null;
var test_results = null;
var test_interval = null;

$(document).ready(function() {
	runtests(1, null);
});
function clearresults() {
	$("#result").html("");
}
function runtests(target_size, last_test) {
	
	if(target_size > 50 || (last_test != null && last_test.Diff > 30000)) {
		//end of all things;
		//$('#result').append("<p>End</p>");
		var ttime = ((new Date()).getTime() -test_start.getTime());
		$("#current").html("Finished tests in " + ttime + "ms/"+ ttime/1000 + "s");
		
		test_start = null;
		test_results = null;
		return;
	}
	
	if(test_start == null) {
		test_start = new Date();
	}
	
	$("#current").html("Running "+target_size +"MB test <span id=\"currentper\"></span>");
	
	var start = new Date();
	/*$.get('/download?size=' + target_size, function() {
		var end = new Date();
		var r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
		var MBps = ((target_size*512*1024)/(r.Diff*1000));
		$('#result').append("<p>"+target_size +"MB in "+r.Diff+"ms @ "+MBps.toString().substring(0,5)+"MBps or "+(MBps*8).toString().substring(0,5)+"Mbps</p>");
		runtests(Math.ceil(target_size*1.5), r);
	});*/
	var xreq = $.ajax('./download?size=' + target_size, {
		progress: function(e) {
			//console.log((e.loaded/e.total)*100);
			$("#currentper").html(Math.ceil((e.loaded/e.total)*100).toString() + "% ");
		}
	}).progress(function(a){
		$("#currentper").html(a)
		alert(a);
	}).done(function() {
		var end = new Date();
		var r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
		var MBps = ((target_size*1024*1024)/(r.Diff*1000));
		$('#result').append("<p>"+target_size +"MB in "+r.Diff+"ms @ "+MBps.toString().substring(0,5)+"MBps or "+(MBps*8).toString().substring(0,5)+"Mbps</p>");
		runtests(Math.ceil(target_size*1.5), r);
	}).always(function() {
		clearInterval(test_interval);
		test_interval = null;
	});
}
function testspeed(size, cb) {
	var start = new Date();
	$.get('/download?size=' + size, function() {
		var end = new Date();
		cb({"Start": start, "End": end, "Diff": end.getTime() - start.getTime()});
	});
}
</script>
</head>
<body>
	<button onclick="runtests(1, null)">Run</button>
	<button onclick="clearresults(1)">Clear results</button>
	<div id="current" ></div>
	<!--<div id="currentper" ></div>-->
	<div id="result"></div>
	<div><a href="https://github.com/snoj/speedtest">github</a></div>
</body>
</html>
