<html>
<head>
<script type="application/javascript" src="./jquery.js" ></script>
<script type="application/javascript">

//var target_size = 1;
var lock = false;
var test_start = null;
var test_results = null;
var test_interval = null;

$(document).ready(function() {
	//runtests(1, null);
});
function clearresults() {
	$("#result").html("");
}
function runtests(target_size, last_test) {
	
	if(target_size > 50 || (last_test != null && last_test.Diff > 30000)) {
		//end of all things;
		//$('#result').append("<p>End</p>");
		$("#current").html("Finished tests in " + ((new Date()).getTime() -test_start.getTime()) + "ms");
		
		test_start = null;
		test_results = null;
		return;
	}
	
	if(test_start == null) {
		test_start = new Date();
	}
	
	$("#current").html("Running "+target_size +"MB test");
	
	var start = new Date();
	/*$.get('/download?size=' + target_size, function() {
		var end = new Date();
		var r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
		var MBps = ((target_size*512*1024)/(r.Diff*1000));
		$('#result').append("<p>"+target_size +"MB in "+r.Diff+"ms @ "+MBps.toString().substring(0,5)+"MBps or "+(MBps*8).toString().substring(0,5)+"Mbps</p>");
		runtests(Math.ceil(target_size*1.5), r);
	});*/
	$.ajax('/download?size=' + target_size, {
		success:  function() {
			var end = new Date();
			var r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
			var MBps = ((target_size*512*1024)/(r.Diff*1000));
			$('#result').append("<p>"+target_size +"MB in "+r.Diff+"ms @ "+MBps.toString().substring(0,5)+"MBps or "+(MBps*8).toString().substring(0,5)+"Mbps</p>");
			runtests(Math.ceil(target_size*1.5), r);
		}
		,xhr: function() {
			//jQuery.ajaxSettings.xhr();
			test_interval = setInterval(function() {
			total = parseInt(xhr.getResponseHeader('Content-length'));
			
			}
		}
		
	});
}
function testspeed(size, cb) {
	var start = new Date();
	$.get('/download?size=' + size, function() {
		var end = new Date();
		cb({"Start": start, "End": end, "Diff": end.getTime() - start.getTime()});
	});
}
</script>
</head>
<body>
	<button value="Run" onclick="runtests(1, null)">Run</button>
	<button value="Run" onclick="clearresults(1)">Clear results</button>
	<div id="current" ></div>
	<div id="result"></div>
</body>
</html>
