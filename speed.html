<html>
<head>
<script type="application/javascript" src="./jquery.js" ></script>
<script type="application/javascript" src="./jquery.ajax-progress.js" ></script>
<script type="application/javascript">

//var target_size = 1;
var lock = false;
var test_start = null;
var test_down_results = [];
var test_up_results = [];
var test_interval = null;
var xreq;
$(document).ready(function() {
	$.get("./ip", function(res) {
		$("#remoteip").text(res)
	});
	$.get("");
});
function clearresults() {
	$("#result").html("");
}
function stoptests() {
	try {
		xreq.abort();
	} catch(e) {}
}
function rundowntests(target_size, last_test, runupload) {
	runupload = runupload || false;
	if(test_down_results != null && test_down_results.length > 0) {
		var slowest, fastest, average = null;
		for(var i = 0; i < test_down_results.length; i++) {
			slowest = (slowest == null || test_down_results[i].MBps < slowest.MBps) ? test_down_results[i] : slowest;
			fastest = (fastest == null || test_down_results[i].MBps > fastest.MBps) ? test_down_results[i] : fastest;
			average += test_down_results[i].MBps;
		}
		$("#stat_download_slowest span").text(Math.round(slowest.MBps*8*100)/100 + "Mbps ("+slowest.TargetSize/1024/1024+"MB)");
		$("#stat_download_fastest span").text(Math.round(fastest.MBps*8*100)/100 + "Mbps ("+fastest.TargetSize/1024/1024+"MB)")
		$("#stat_download_average span").text(Math.round((average/test_down_results.length)*8*100)/100 + "Mbps");
	}
	
	if(target_size > $("#maxDownloadSize").val() || (last_test != null && last_test.Diff > $("#maxDownloadTime").val()* 1000)) {
		//end of all things;
		var ttime = ((new Date()).getTime() -test_start.getTime());
		$("#current").html("");
		$("#result").append("<p>Finished download tests in "+ ttime/1000 + "s</p>");
		
		test_start = null;
		test_down_results = [];
		if(runupload) {
			runuptests($('#uploadStartSize').val(), null);
		}
		return;
	}
	
	
	if(test_start == null) {
		test_start = new Date();
	}
	
	$("#current").html("Running "+target_size +"MB download test <span id=\"currentper\"></span>");
	var r = {}; //results
	var start = new Date();
	xreq = $.ajax('./download?size=' + target_size, {
		progress: function(e) {
			var curspeed =  (e.loaded/(((new Date()).getTime() - start.getTime())))/1000
			r.ActualSize = e.total;
			r.Loaded = e.loaded;
			$("#currentper").html(Math.ceil((e.loaded/e.total)*100).toString() + "% @ "+Math.round(curspeed*8*100)/100+"Mbps ("+Math.round(e.loaded/1024)+"/"+e.total/1024+"KB)");
			
		}
	}).done(function() {
		var end = new Date();
		//r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
		r.Start = start;
		r.End = end;
		r.Diff = end.getTime() - start.getTime();
		var MBps = ((target_size*1024*1024)/(r.Diff))/1000;
		r.MBps = MBps;
		r.TargetSize = target_size*1024*1024;
		test_down_results.push(r);
		
		$('#result').append("<p>"+target_size +"MB in "+Math.round(r.Diff*100)/100+"s @ "+Math.round(MBps*8*100)/100+"Mbps ("+MBps.toString().substring(0,5)+"MBps)</p>");
		rundowntests(Math.ceil(target_size*1.5), r, runupload);
	}).always(function() {
		clearInterval(test_interval);
		test_interval = null;
	});
}
var upload_data = [];
var createdataInterval = null;
function runuptests(target_size, last_test) {
	//var d = [];
	
	if(test_start == null) {
		test_start = new Date();
	}
	
	if(test_up_results.length >= $("#maxUploadInterations").val() || target_size > $("#maxUploadSize").val() || (last_test != null && last_test.Diff != null && last_test.Diff > $("#maxUploadTime").val()*1000)) {
		var ttime = ((new Date()).getTime() -test_start.getTime());
		$("#current").html("");
		$("#result").append("<p>Finished upload tests in "+ ttime/1000 + "s</p>");
		test_up_results = [];
		return;
	}
	
	if(test_up_results.length > 0) {
		var slowest, fastest, average = null;
		
		for(var i = 0; i < test_up_results.length; i++) {
			slowest = (slowest == null || test_up_results[i].MBps < slowest.MBps) ? test_up_results[i] : slowest;
			fastest = (fastest == null || test_up_results[i].MBps > fastest.MBps) ? test_up_results[i] : fastest;
			average += test_up_results[i].MBps;
		}
		
		$("#stat_upload_slowest span").text(Math.round(slowest.MBps*8*100)/100 + "Mbps ("+slowest.TargetSize/1024/1024+"MB)");
		$("#stat_upload_fastest span").text(Math.round(fastest.MBps*8*100)/100 + "Mbps ("+fastest.TargetSize/1024/1024+"MB)")
		$("#stat_upload_average span").text(Math.round((average/test_up_results.length)*8*100)/100 + "Mbps");
	}
	
	for(var i = 0; upload_data.length < target_size*1024*1024; i++) {
		upload_data.push(0);
	}
	if(createdataInterval == null) {
		 createdataInterval = setInterval(function() {
			//$("#current").text(upload_data.length + (new Date()));
			if(upload_data.length >= target_size*1024*1024) {
				clearInterval(createdataInterval);
				createdataInterval = null;
				
				$("#current").html("Running "+target_size +"MB upload test <span id=\"currentper\"></span>");
				var r = {};
				var start = new Date();
				xreq = $.ajax('./upload?size=' + target_size, {
					type: "post"
					,processData: false
					,contentType: "image/png"
					,headers: {
						//"Content-length": target_size*1024*1024
					}
					,progress: function(e) {
						//this isn't called?
						//$("#current").text(e.loaded);
						//console.log(e);
						var curspeed =  (e.loaded/(((new Date()).getTime() - start.getTime())))/1000
						r.ActualSize = e.total;
						r.Loaded = e.loaded;
						$("#currentper").html(Math.ceil((e.loaded/e.total)*100).toString() + "% @ "+Math.round(curspeed*8*100)/100+"Mbps ("+Math.round(e.loaded/1024)+"/"+e.total/1024+"KB)");
					}
					,data: upload_data.join("")
				}).done(function() {
					var end = new Date();
					//r = {"Start": start, "End": end, "Diff": end.getTime() - start.getTime()};
					r.Start = start;
					r.End = end;
					r.Diff = end.getTime() - start.getTime();
					var MBps = ((target_size*1024*1024)/(r.Diff))/1000;
					r.MBps = MBps;
					r.TargetSize = target_size*1024*1024;
					test_up_results.push(r);
					//$("#current").text("Upload complete");
					$('#result').append("<p>"+target_size +"MB in "+Math.round(r.Diff*100)/100+"s @ "+Math.round(MBps*8*100)/100+"Mbps ("+MBps.toString().substring(0,5)+"MBps)</p>");
				}).always(function() {
					runuptests(Math.round(target_size*$("#uploadSizeModifier").val()), r);
				});
			}
		}, 10);
	}
}
</script>
</head>
<body>
	<div>Your IP: <span id="remoteip"></span></div>
	<button onclick="rundowntests($('#downloadStartSize').val(), null)">Download</button>
	<button onclick="runuptests($('#uploadStartSize').val(), null)">Upload</button>
	<button onclick="rundowntests($('#downloadStartSize').val(), null, true)">Both</button>
	<button onclick="stoptests()">Stop</button>
	<button onclick="clearresults()">Clear results</button>
	<div style="display:none">
		<input type="text" id="downloadStartSize" value="1"/>
		<input type="text" id="downloadSizeModifier" value="1.5"/>
		<input type="text" id="uploadStartSize" value="2"/>
		<input type="text" id="uploadSizeModifier" value="1"/>
		<input type="text" id="maxDownloadSize" value="50"/>
		<input type="text" id="maxUploadSize" value="20"/>
		<input type="text" id="maxDownloadTime" value="30"/>
		<input type="text" id="maxUploadTime" value="20"/>
		<!--<input type="text" id="maxDownloadInterations" value="-1"/> -->
		<input type="text" id="maxUploadInterations" value="5"/>
	</div>
	<div id="current" ></div>
	<!--<div id="currentper" ></div>-->
	<div style="margin:0px auto;">
		<div id="result" style="float:left; width: 500px; min-height: 400px; border-right: 1px solid black;"><p></p></div>
		<div id="stats" style="float:left; text-align:left;">
			<div id="download">
				<h3>Download</h3>
				<div id="stat_download_slowest">Slowest: <span></span></div>
				<div id="stat_download_fastest">Fastest: <span></span></div>
				<div id="stat_download_average">Average: <span></span></div>
			</div>
			<div  id="upload">
				<h3>Upload</h3>
				<div id="stat_upload_slowest">Slowest: <span></span></div>
				<div id="stat_upload_fastest">Fastest: <span></span></div>
				<div id="stat_upload_average">Average: <span></span></div>
			</div>
		</div>
		<div style="clear:both;"> </div>
	</div>
	<div><a href="https://github.com/snoj/speedtest">github</a></div>
</body>
</html>
